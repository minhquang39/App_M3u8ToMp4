<Window x:Class="M3U8ConverterApp.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="M3U8 to MP4 Converter"
        Width="900"
        Height="600"
        MinWidth="700"
        MinHeight="480"
        Icon="Assets/icon.ico">
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    </Window.Resources>
    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        <Grid Margin="0,0,0,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="110"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBlock Text="M3U8 URL:" VerticalAlignment="Center" Margin="0,0,8,0"/>
            <TextBox Grid.Column="1"
                     Text="{Binding SourceUrl, UpdateSourceTrigger=PropertyChanged}"
                     ToolTip="Remote playlist URL (.m3u8)"
                     VerticalContentAlignment="Center" />
            <Button Grid.Column="2"
                    Margin="8,0,0,0"
                    Padding="12 4"
                    Content="Paste"
                    Command="{Binding PasteUrlCommand}"
                    ToolTip="Paste URL from clipboard"/>
        </Grid>

        <Grid Grid.Row="1" Margin="0,0,0,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="110"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBlock Text="Output file:" VerticalAlignment="Center" Margin="0,0,8,0"/>
            <TextBox Grid.Column="1"
                     Text="{Binding OutputPath, UpdateSourceTrigger=PropertyChanged}"
                     VerticalContentAlignment="Center"
                     ToolTip="Destination MP4 path"/>
            <Button Grid.Column="2"
                    Margin="8,0,0,0"
                    Padding="12 4"
                    Content="Browse..."
                    Command="{Binding BrowseOutputCommand}"/>
        </Grid>

        <Grid Grid.Row="2" Margin="0,0,0,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="110"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <TextBlock Text="Downloader:" VerticalAlignment="Center" Margin="0,0,8,0"/>
            <StackPanel Grid.Column="1">
                <ComboBox ItemsSource="{Binding EngineOptions}"
                          SelectedItem="{Binding SelectedEngineOption}"
                          DisplayMemberPath="DisplayName"
                          Margin="0,0,0,4"
                          MinHeight="28"/>
                <TextBlock Text="{Binding SelectedEngineOption.Description}"
                           Foreground="Gray"
                           FontSize="11"
                           TextWrapping="Wrap"/>
            </StackPanel>
        </Grid>

        <Grid Grid.Row="3" Margin="0,0,0,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="110"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBlock Text="FFmpeg path:" VerticalAlignment="Center" Margin="0,0,8,0"/>
            <TextBox Grid.Column="1"
                     Text="{Binding FfmpegPath, UpdateSourceTrigger=PropertyChanged}"
                     VerticalContentAlignment="Center"
                     ToolTip="Location of ffmpeg.exe"/>
            <Button Grid.Column="2"
                    Margin="8,0,0,0"
                    Padding="12 4"
                    Content="Browse..."
                    Command="{Binding BrowseFfmpegCommand}"/>
        </Grid>

        <Grid Grid.Row="4" Margin="0,0,0,12" IsEnabled="{Binding IsNm3u8DlReSelected}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="110"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBlock Text="N_m3u8DL-RE path:" VerticalAlignment="Center" Margin="0,0,8,0"/>
            <TextBox Grid.Column="1"
                     Text="{Binding Nm3u8DlRePath, UpdateSourceTrigger=PropertyChanged}"
                     VerticalContentAlignment="Center"
                     ToolTip="Location of N_m3u8DL-RE.exe"/>
            <Button Grid.Column="2"
                    Margin="8,0,0,0"
                    Padding="12 4"
                    Content="Browse..."
                    Command="{Binding BrowseNm3u8Command}"/>
        </Grid>

        <Grid Grid.Row="5"
              Margin="0,0,0,12"
              IsEnabled="{Binding IsNm3u8DlReSelected}"
              Visibility="{Binding IsNm3u8DlReSelected, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="110"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <TextBlock Text="Thread count:" VerticalAlignment="Center" Margin="0,0,8,0"/>
            <StackPanel Grid.Column="1" Orientation="Horizontal">
                <TextBox Width="80"
                         Text="{Binding Nm3u8ThreadCount, UpdateSourceTrigger=PropertyChanged}"
                         VerticalContentAlignment="Center"
                         ToolTip="Maximum number of segments to download concurrently (1-128)."/>
                <TextBlock Margin="8,0,0,0" VerticalAlignment="Center" Foreground="Gray" FontSize="11"
                           Text="Higher values increase concurrency but may stress the server."/>
            </StackPanel>
        </Grid>

        <GroupBox Grid.Row="6"
                  Header="N_m3u8DL-RE track selection"
                  Visibility="{Binding IsNm3u8DlReSelected, Converter={StaticResource BoolToVisibilityConverter}}"
                  Margin="0,0,0,12">
            <StackPanel>
                <CheckBox Content="Auto-select best available video/audio (recommended)"
                          IsChecked="{Binding Nm3u8AutoSelect}"/>
                <StackPanel Margin="0,8,0,0">
                    <Grid Margin="0,0,0,8"
                          IsEnabled="{Binding IsNm3u8ManualSelection}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Video selection:" Margin="0,0,8,0" VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding Nm3u8VideoSelection, UpdateSourceTrigger=PropertyChanged}"
                                 VerticalContentAlignment="Center"
                                 ToolTip="Expression passed to --select-video (e.g. best, res=&quot;1920*1080&quot;, id=REGEX...)."/>
                    </Grid>
                    <Grid Margin="0,0,0,8"
                          IsEnabled="{Binding IsNm3u8ManualSelection}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Audio selection:" Margin="0,0,8,0" VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding Nm3u8AudioSelection, UpdateSourceTrigger=PropertyChanged}"
                                 VerticalContentAlignment="Center"
                                 ToolTip="Expression passed to --select-audio (e.g. best, lang=en, id=REGEX...)."/>
                    </Grid>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <CheckBox Content="Download subtitles"
                                  IsChecked="{Binding Nm3u8IncludeSubtitles}"/>
                        <TextBlock Margin="8,0,0,0" VerticalAlignment="Center" Foreground="Gray" FontSize="11"
                                   Text="Uses --select-subtitle (default 'all')."/>
                    </StackPanel>
                    <Grid IsEnabled="{Binding Nm3u8IncludeSubtitles}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Subtitle selection:" Margin="0,0,8,0" VerticalAlignment="Center"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding Nm3u8SubtitleSelection, UpdateSourceTrigger=PropertyChanged}"
                                 VerticalContentAlignment="Center"
                                 ToolTip="Expression passed to --select-subtitle (e.g. all, lang=en, name=REGEX...)."/>
                    </Grid>
                </StackPanel>
                <TextBlock Margin="0,8,0,0"
                           Foreground="Gray"
                           FontSize="11"
                           Text="Selection syntax follows N_m3u8DL-RE options (see --morehelp select-video/audio/subtitle)."/>
            </StackPanel>
        </GroupBox>

        <CheckBox Grid.Row="7"
                  Content="Aggressive HTTP (persistent &amp; multiple requests for VOD)"
                  IsChecked="{Binding UseAggressiveHttp}"
                  Margin="0,0,0,12"
                  IsEnabled="{Binding IsFfmpegSelected}"
                  ToolTip="Adds -multiple_requests 1 and -http_persistent 1 to ffmpeg to reuse HTTP connections."/>

        <StackPanel Grid.Row="8" Orientation="Horizontal" HorizontalAlignment="Left" Margin="0,0,0,12">
            <Button Content="Start"
                    MinWidth="100"
                    Command="{Binding StartCommand}"
                    IsDefault="True"
                    Margin="0,0,8,0"/>
            <Button Content="Cancel"
                    MinWidth="100"
                    Command="{Binding CancelCommand}"
                    IsEnabled="{Binding IsBusy}"
                    Margin="0,0,8,0"/>
            <Button Content="Open output folder"
                    MinWidth="150"
                    Command="{Binding OpenOutputFolderCommand}"/>
        </StackPanel>

        <Grid Grid.Row="9" Margin="0,0,0,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <ProgressBar Height="20"
                         Value="{Binding ProgressPercent, Mode=OneWay}"
                         Maximum="100"/>
            <StackPanel Grid.Column="1" Orientation="Vertical" Margin="12,0,0,0">
                <TextBlock Text="{Binding StatusMessage}" FontWeight="Bold"/>
                <TextBlock Text="{Binding ProgressDetails}" FontSize="11" Foreground="Gray"/>
            </StackPanel>
        </Grid>

        <GroupBox Grid.Row="10" Header="Activity log">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <ListBox ItemsSource="{Binding Logs}" FontFamily="Consolas" FontSize="12"/>
                <TextBlock Grid.Row="1"
                           Margin="0,4,0,0"
                           Foreground="Gray"
                           FontSize="11"
                           Text="Progress is parsed from ffmpeg output and may lag behind actual completion slightly."/>
            </Grid>
        </GroupBox>
    </Grid>
</Window>
